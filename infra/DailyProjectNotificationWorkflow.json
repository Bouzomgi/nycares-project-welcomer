{
  "Comment": "Project Notifier Step Functions Workflow (Single Message, Auth Passed, DLQ Handling)",
  "StartAt": "Login",
  "States": {
    "Login": {
      "Type": "Task",
      "Resource": "${LoginLambdaArn}",
      "ResultPath": "$",
      "Next": "FetchProjects",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "DLQNotifier"
        }
      ]
    },
    "FetchProjects": {
      "Type": "Task",
      "Resource": "${FetchProjectsLambdaArn}",
      "InputPath": "$",
      "ResultPath": "$.projects",
      "Next": "ProcessEachProject",
      "Catch": [
        {
          "ErrorEquals": ["AuthFailureException"],
          "Next": "Login"
        },
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "DLQNotifier"
        }
      ]
    },
    "ProcessEachProject": {
      "Type": "Map",
      "ItemsPath": "$.projects.projects",
      "Parameters": {
        "project.$": "$$.Map.Item.Value",
        "auth.$": "$.auth"
      },
      "Iterator": {
        "StartAt": "ComputeMessageToSend",
        "States": {
          "ComputeMessageToSend": {
            "Type": "Task",
            "Resource": "${ComputeMessageToSendLambdaArn}",
            "InputPath": "$",
            "ResultPath": "$",
            "Next": "RequestApprovalToSend",
            "Catch": [
              {
                "ErrorEquals": ["ProjectTooFar", "ProjectPassed"],
                "Next": "EndProjectIteration"
              },
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "DLQNotifier"
              }
            ]
          },
          "RequestApprovalToSend": {
            "Type": "Task",
            "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
            "TimeoutSeconds": 86400,
            "Comment": "86400 seconds = 24 hours approval window",
            "Parameters": {
              "FunctionName": "${RequestApprovalToSendLambdaArn}",
              "Payload": {
                "taskToken.$": "$$.Task.Token",
                "$.$": "$"
              }
            },
            "ResultPath": "$.approvalResult",
            "Next": "SendAndPinMessage",
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "DLQNotifier"
              }
            ]
          },
          "SendAndPinMessage": {
            "Type": "Task",
            "Resource": "${SendAndPinMessageLambdaArn}",
            "InputPath": "$",
            "ResultPath": "$",
            "Next": "RecordMessage",
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "DLQNotifier"
              }
            ]
          },
          "RecordMessage": {
            "Type": "Task",
            "Resource": "${RecordMessageLambdaArn}",
            "InputPath": "$",
            "ResultPath": "$",
            "Next": "NotifyCompletion",
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "DLQNotifier"
              }
            ]
          },
          "NotifyCompletion": {
            "Type": "Task",
            "Resource": "${NotifyCompletionLambdaArn}",
            "InputPath": "$",
            "End": true,
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "DLQNotifier"
              }
            ]
          },
          "DLQNotifier": {
            "Type": "Task",
            "Resource": "${DLQNotifierLambdaArn}",
            "InputPath": "$",
            "End": true
          },
          "EndProjectIteration": {
            "Type": "Pass",
            "End": true
          }
        }
      },
      "Next": "EndWorkflow"
    },
    "EndWorkflow": {
      "Type": "Pass",
      "End": true
    },
    "DLQNotifier": {
      "Type": "Task",
      "Resource": "${DLQNotifierLambdaArn}",
      "InputPath": "$",
      "End": true
    }
  }
}
